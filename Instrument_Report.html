<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrial Instrumentation Report Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <style>
    body {
        background-color: #121212;
        color: #ffffff;
    }
    .form-control, .btn {
        background-color: #1e1e1e;
        color: #ffffff;
        border: 1px solid #333;
    }
    .btn-primary {
        background-color: #6200ea;
        border: none;
    }
    .btn-success {
        background-color: #03dac6;
        border: none;
    }
    .btn:hover {
        opacity: 0.9;
    }
    .form-label {
        color: #b0bec5;
    }
    #pdfContent {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        color: #000000;
        padding: 10px 20px 20px 20px;
        margin: 0;
        background: #f8f9fa;
        min-height: 100vh;
        box-sizing: border-box;
    }
    #pdfContent h1 {
        font-size: 28px;
        margin-bottom: 10px;
        margin-top: 0;
        text-align: center;
        color: #333;
        padding-top: 0;
    }
    #pdfContent h3 {
        font-size: 20px;
        margin-top: 16px;
        color: #222;
        border-bottom: 1px solid #bbb;
        padding-bottom: 4px;
    }
    #pdfContent .instrument-section {
        border: 1px solid #bbb;
        border-radius: 8px;
        background: #fff;
        padding: 16px 20px;
        margin-bottom: 18px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        page-break-inside: avoid;
    }
    #pdfContent p {
        margin: 4px 0;
        font-size: 15px;
    }
    #pdfContent .data-label {
        color: #555;
        font-weight: bold;
    }
    #pdfContent .cal-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 14px;
        background: #fafbfc;
    }
    #pdfContent .cal-table th, #pdfContent .cal-table td {
        border: 1px solid #bbb;
        padding: 4px 6px;
        text-align: center;
    }
    #pdfContent .cal-table th {
        background: #f0f0f0;
    }
    #pdfContent .cal-graph {
        max-width: 400px;
        border: 1px solid #ccc;
        margin-bottom: 10px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        background: #fff;
    }
    #pdfContent .section {
        margin-bottom: 18px;
    }
    #pdfFooter {
        text-align: right;
        font-size: 12px;
        color: #888;
        margin-top: 30px;
    }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Instrumentation Report Generator</h1>
        <form id="instrumentForm">
            <div class="mb-3">
                <label for="docHeader" class="form-label">Document Header:</label>
                <input type="text" id="docHeader" class="form-control" placeholder="Enter the document header">
            </div>
            <div class="mb-3">
                <label for="docInfo" class="form-label">Document Information:</label>
                <textarea id="docInfo" class="form-control" rows="3" placeholder="Enter details about the document (e.g., purpose, author, etc.)"></textarea>
            </div>
            <div id="instrumentContainer">
                <div class="instrument mb-3">
                    <h3>Instrument 1</h3>
                    <div class="mb-3">
                        <label class="form-label">Instrument Type:</label>
                        <input type="text" class="form-control instrumentType" placeholder="e.g., Pressure Transmitter">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Manufacturer:</label>
                        <input type="text" class="form-control manufacturer" placeholder="e.g., Yokogawa">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Model:</label>
                        <input type="text" class="form-control model" placeholder="e.g., EJA530E">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Range:</label>
                        <input type="text" class="form-control range" placeholder="e.g., 0-100 PSI">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Accuracy:</label>
                        <input type="text" class="form-control accuracy" placeholder="e.g., ±0.1%">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Last Calibration Date:</label>
                        <input type="date" class="form-control lastCalibrationDate">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Calibration Date:</label>
                        <input type="date" class="form-control newCalibrationDate">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Inspection Result:</label>
                        <select class="form-control inspectionResult">
                            <option value="Pass">Pass</option>
                            <option value="Fail">Fail</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Inspection Description:</label>
                        <textarea class="form-control inspectionDescription" rows="2" placeholder="Describe inspection findings..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Calibration Data Points (comma-separated):</label>
                        <input type="text" class="form-control calibrationData" placeholder="e.g., 0,10,20,30,40,50">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Actual Values (comma-separated):</label>
                        <input type="text" class="form-control actualData" placeholder="e.g., 0,9.8,20.2,29.9,40.1,50.3">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Calibration Graph Preview:</label>
                        <canvas class="calibrationChart" width="400" height="200" style="background:#fff;"></canvas>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Inspector Signature:</label><br>
                <canvas id="signaturePad" width="400" height="120" style="border:1px solid #ccc; background:#fff;"></canvas>
                <br>
                <button type="button" id="clearSignature" class="btn btn-secondary btn-sm mt-2">Clear Signature</button>
            </div>
            <button type="button" id="addInstrument" class="btn btn-primary mb-3">Add Another Instrument</button>
            <button type="button" id="generatePdf" class="btn btn-success">Generate PDF</button>
        </form>
    </div>

    <div id="pdfContent" style="display:none">
        <h1 id="pdfHeader"></h1>
        <p id="pdfInfo" class="section"></p>
        <div id="pdfInstruments" class="section"></div>
        <div id="pdfFooter"></div>
    </div>

    <script>
        let instrumentCount = 1;
        let signaturePad;

        window.addEventListener('DOMContentLoaded', () => {
            // Initialize signature pad
            const canvas = document.getElementById('signaturePad');
            signaturePad = new SignaturePad(canvas);

            document.getElementById('clearSignature').onclick = () => signaturePad.clear();
        });

        document.getElementById('addInstrument').addEventListener('click', () => {
            instrumentCount++;
            const container = document.getElementById('instrumentContainer');
            const instrumentDiv = document.createElement('div');
            instrumentDiv.className = 'instrument mb-3';
            instrumentDiv.innerHTML = `
                <h3>Instrument ${instrumentCount}</h3>
                <div class="mb-3">
                    <label class="form-label">Instrument Type:</label>
                    <input type="text" class="form-control instrumentType" placeholder="e.g., Pressure Transmitter">
                </div>
                <div class="mb-3">
                    <label class="form-label">Manufacturer:</label>
                    <input type="text" class="form-control manufacturer" placeholder="e.g., Yokogawa">
                </div>
                <div class="mb-3">
                    <label class="form-label">Model:</label>
                    <input type="text" class="form-control model" placeholder="e.g., EJA530E">
                </div>
                <div class="mb-3">
                    <label class="form-label">Range:</label>
                    <input type="text" class="form-control range" placeholder="e.g., 0-100 PSI">
                </div>
                <div class="mb-3">
                    <label class="form-label">Accuracy:</label>
                    <input type="text" class="form-control accuracy" placeholder="e.g., ±0.1%">
                </div>
                <div class="mb-3">
                    <label class="form-label">Last Calibration Date:</label>
                    <input type="date" class="form-control lastCalibrationDate">
                </div>
                <div class="mb-3">
                    <label class="form-label">New Calibration Date:</label>
                    <input type="date" class="form-control newCalibrationDate">
                </div>
                <div class="mb-3">
                    <label class="form-label">Inspection Result:</label>
                    <select class="form-control inspectionResult">
                        <option value="Pass">Pass</option>
                        <option value="Fail">Fail</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Inspection Description:</label>
                    <textarea class="form-control inspectionDescription" rows="2" placeholder="Describe inspection findings..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Calibration Data Points (comma-separated):</label>
                    <input type="text" class="form-control calibrationData" placeholder="e.g., 0,10,20,30,40,50">
                </div>
                <div class="mb-3">
                    <label class="form-label">Actual Values (comma-separated):</label>
                    <input type="text" class="form-control actualData" placeholder="e.g., 0,9.8,20.2,29.9,40.1,50.3">
                </div>
                <div class="mb-3">
                    <label class="form-label">Calibration Graph Preview:</label>
                    <canvas class="calibrationChart" width="400" height="200" style="background:#fff;"></canvas>
                </div>
            `;
            container.appendChild(instrumentDiv);
            setupChartForInstrument(instrumentDiv);
        });

        // Setup chart for all current instruments on page load
        document.querySelectorAll('.instrument').forEach(setupChartForInstrument);

        function setupChartForInstrument(instrumentDiv) {
            const calInput = instrumentDiv.querySelector('.calibrationData');
            const actInput = instrumentDiv.querySelector('.actualData');
            const canvas = instrumentDiv.querySelector('.calibrationChart');
            let chart;
            function updateChart() {
                const calData = calInput.value.split(',').map(Number).filter(x => !isNaN(x));
                const actData = actInput.value.split(',').map(Number).filter(x => !isNaN(x));
                if (chart) chart.destroy();
                chart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: calData.map((_, i) => `Pt ${i+1}`),
                        datasets: [
                            {
                                label: 'Calibration Data',
                                data: calData,
                                borderColor: '#6200ea',
                                backgroundColor: 'rgba(98,0,234,0.1)',
                                fill: true,
                                tension: 0.2
                            },
                            {
                                label: 'Actual Values',
                                data: actData,
                                borderColor: '#03dac6',
                                backgroundColor: 'rgba(3,218,198,0.1)',
                                fill: false,
                                tension: 0.2
                            }
                        ]
                    },
                    options: { responsive: false, plugins: { legend: { display: true } } }
                });
            }
            calInput.addEventListener('input', updateChart);
            actInput.addEventListener('input', updateChart);
        }

        function generateCalibrationNumber(idx) {
            // Example: CAL-20250519-1-XYZ12A (date + instrument idx + random 5-char alphanumeric)
            const today = new Date();
            const dateStr = today.toISOString().slice(0,10).replace(/-/g, '');
            const rand = Math.random().toString(36).substring(2, 7).toUpperCase();
            return `CAL-${dateStr}-${idx + 1}-${rand}`;
        }

        document.getElementById('generatePdf').addEventListener('click', async () => {
            document.getElementById('pdfHeader').textContent = document.getElementById('docHeader').value;
            document.getElementById('pdfInfo').textContent = document.getElementById('docInfo').value;

            const instruments = document.querySelectorAll('#instrumentContainer .instrument');
            let instrumentsHtml = '';
            const today = new Date();
            const dateStr = today.toISOString().slice(0,10);

            // Prepare calibration chart images and error tables
            const chartImages = [];
            const errorTables = [];
            for (const inst of instruments) {
                const calData = inst.querySelector('.calibrationData').value.split(',').map(Number);
                const actData = inst.querySelector('.actualData').value.split(',').map(Number);
                // Calculate % error
                let errorRows = '';
                for (let i = 0; i < Math.max(calData.length, actData.length); i++) {
                    const cal = calData[i];
                    const act = actData[i];
                    let err = '';
                    if (typeof cal === 'number' && !isNaN(cal) && typeof act === 'number' && !isNaN(act)) {
                        if (cal === 0) {
                            err = 'N/A';
                        } else {
                            err = (((act - cal) / cal) * 100).toFixed(2) + '%';
                        }
                    } else {
                        err = '';
                    }
                    errorRows += `<tr>
                        <td>${i+1}</td>
                        <td>${isNaN(cal) ? '' : cal}</td>
                        <td>${isNaN(act) ? '' : act}</td>
                        <td>${err}</td>
                    </tr>`;
                }
                errorTables.push(`
                    <table class="cal-table">
                        <thead>
                            <tr>
                                <th>Point</th>
                                <th>Calibration</th>
                                <th>Actual</th>
                                <th>% Error</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${errorRows}
                        </tbody>
                    </table>
                `);
                const canvas = inst.querySelector('.calibrationChart');
                chartImages.push(canvas ? canvas.toDataURL('image/png') : null);
            }

            instruments.forEach((inst, idx) => {
                const type = inst.querySelector('.instrumentType').value;
                const manufacturer = inst.querySelector('.manufacturer').value;
                const model = inst.querySelector('.model').value;
                const range = inst.querySelector('.range').value;
                const accuracy = inst.querySelector('.accuracy').value;
                const lastCal = inst.querySelector('.lastCalibrationDate').value;
                const newCal = inst.querySelector('.newCalibrationDate').value;
                const result = inst.querySelector('.inspectionResult').value;
                const desc = inst.querySelector('.inspectionDescription').value;
                const calData = inst.querySelector('.calibrationData').value;
                const actData = inst.querySelector('.actualData').value;
                const calNum = generateCalibrationNumber(idx);

                instrumentsHtml += `
                    <div class="instrument-section">
                        <h3>Instrument ${idx + 1}</h3>
                        <p><span class="data-label">Calibration Number:</span> ${calNum}</p>
                        <p><span class="data-label">Type:</span> ${type}</p>
                        <p><span class="data-label">Manufacturer:</span> ${manufacturer}</p>
                        <p><span class="data-label">Model:</span> ${model}</p>
                        <p><span class="data-label">Range:</span> ${range}</p>
                        <p><span class="data-label">Accuracy:</span> ${accuracy}</p>
                        <p><span class="data-label">Last Calibration Date:</span> ${lastCal}</p>
                        <p><span class="data-label">New Calibration Date:</span> ${newCal}</p>
                        <p><span class="data-label">Inspection Result:</span> ${result}</p>
                        <p><span class="data-label">Inspection Description:</span> ${desc}</p>
                        <p><span class="data-label">Calibration Data:</span> ${calData}</p>
                        <p><span class="data-label">Actual Values:</span> ${actData}</p>
                        <div style="margin:18px 0 0 0; text-align:center;">
                            <img src="${chartImages[idx]}" alt="Calibration Graph" class="cal-graph">
                            <div style="margin-top:10px;">
                                <strong>Calibration Error Table:</strong>
                                ${errorTables[idx]}
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('pdfInstruments').innerHTML = instrumentsHtml;

            // Signature
            const signatureDataUrl = signaturePad && !signaturePad.isEmpty() ? signaturePad.toDataURL() : '';
            document.getElementById('pdfFooter').innerHTML = `
                Report generated on ${dateStr}
                <div style="margin-top:20px;">
                    <strong>Inspector Signature:</strong><br>
                    ${signatureDataUrl ? `<img src="${signatureDataUrl}" style="border:1px solid #ccc; max-width:200px;">` : '<em>No signature provided</em>'}
                </div>
            `;

            const form = document.getElementById('instrumentForm');
            const pdfContent = document.getElementById('pdfContent');
            form.style.display = 'none';
            pdfContent.style.display = 'block';

            // Fix for html2pdf top margin: set margin to a small value and remove padding-top from pdfContent
            setTimeout(() => {
                html2pdf()
                    .set({
                        margin: [0.2, 0.3, 0.3, 0.3], // top, right, bottom, left (inches)
                        filename: `Instrumentation_Report_${dateStr}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, backgroundColor: '#fff', scrollY: 0 },
                        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                    })
                    .from(pdfContent)
                    .save()
                    .then(() => {
                        pdfContent.style.display = 'none';
                        form.style.display = 'block';
                    });
            }, 200);
        });
    </script>
</body>
</html>
